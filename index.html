<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #000000; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
      .card { background: #1f2937; width: 100%; max-width: 500px; padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); text-align: center; position: relative; }
      .header-text { font-family: "Fedra Bold", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-weight: bold; font-size: 28px; color: #f3f4f6; margin-bottom: 30px; margin-top: 5px; }
      .logo { height: 40px; margin-bottom: 20px; object-fit: contain; }
      .cam-toggle { position: absolute; top: 165px; right: 30px; z-index: 10; font-size: 18px; cursor: pointer; background: transparent; border: none; box-shadow: none; width: 36px; height: 36px; display: none; align-items: center; justify-content: center; }
      .cam-toggle:active { transform: scale(0.85); background: transparent; }
      #update-banner { display: none; position: fixed; top: 20px; z-index: 1000; background-color: #064e3b; border: 2px solid #34d399; color: #ffffff; padding: 12px 24px; border-radius: 50px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.5); cursor: default; animation: slideDown 0.5s ease; }
      #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; margin-bottom: 20px; }
      #status-box { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; box-sizing: border-box; padding: 30px; border-radius: 16px; z-index: 100; box-shadow: 0 10px 40px rgba(0,0,0,0.8); animation: popInCenter 0.3s ease; }
      .close-btn { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; opacity: 0.7; line-height: 1; }
      .close-btn:hover { opacity: 1; }
      .success-present { background-color: #064e3b; border: 3px solid #34d399; color: #ffffff; }
      .error   { background-color: #7f1d1d; border: 3px solid #f87171; color: #ffffff; }
      .warning { background-color: #78350f; border: 3px solid #fbbf24; color: #ffffff; }
      h2 { margin: 0 0 10px 0; font-size: 32px; font-weight: 800; }
      p  { margin: 0; font-size: 22px; font-weight: 600; }
      .btn { background-color: #374151; color: white; border: 1px solid #4b5563; padding: 18px 32px; font-size: 18px; font-weight: 600; border-radius: 50px; cursor: pointer; margin-top: 10px; width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
      .btn:disabled { background-color: #4b5563; color: #9ca3af; cursor: not-allowed; border: none; }
      @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes popInCenter { from { transform: translate(-50%, -50%) scale(0.95); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
      
      function applyCameraUI() {
  document.getElementById('start-btn').style.display = 'none';
  document.querySelector('.cam-toggle').style.display = 'flex';
  isScannerRunning = true;
  const r = document.getElementById('reader');

  if (currentFacingMode === "user") {
    r.classList.add('front-cam');
    // Directly target the video element once it exists
    setTimeout(() => {
      const video = r.querySelector('video');
      if (video) video.style.transform = 'scaleX(-1)';
    }, 500);
  } else {
    r.classList.remove('front-cam');
    const video = r.querySelector('video');
    if (video) video.style.transform = 'scaleX(1)';
  }
}
    </style>
  </head>
  <body>
    <div id="update-banner">Schedule has been updated ‚úÖ</div>
    <div class="card">
      <div class="header-text">Sadhana Upgrade - 2026</div>
      <img src="https://lh3.googleusercontent.com/d/1debGmOVxmYmA8EqaOYLKojnKlSzEXOGE=w300" class="logo">
      <div class="cam-toggle" onclick="switchCamera()">üîÑ</div>
      <div id="reader"></div>
      <div id="status-box">
        <div class="close-btn" onclick="closePopup()">√ó</div>
        <h2 id="msg-title"></h2>
        <p id="msg-desc"></p>
      </div>
      <button id="start-btn" class="btn" onclick="startScanner()" disabled>‚è≥ Loading...</button>
    </div>

    <script>
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // !! PASTE YOUR /exec URL HERE !!
      const EXEC_URL = "https://script.google.com/macros/s/AKfycbz23_zNZ2cAtDFjR279bTIZ67wL6zZ9R-UuGbA4iHnX4WrUkP1KTRPnQ0qnn_MIIkHnvg/exec";
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      let participantDB = {};
      let todaySessions = [];
      const localScannedIds = new Set();
      let html5QrcodeScanner = null;
      let isScanning = false;
      let isScannerRunning = false;
      let currentFacingMode = "environment";
      let statusTimer = null;

      // Central fetch helper

      function callBackend(payload) {
  const params = new URLSearchParams(payload).toString();
  return fetch(EXEC_URL + "?" + params).then(r => r.json());
}

      // Load participants + schedule on page load
      callBackend({ action: "getInitialData" })
        .then(data => {
          participantDB = data.participantData;
          todaySessions = data.scheduleData;
          console.log("Loaded", Object.keys(participantDB).length, "participants,", todaySessions.length, "sessions");
        })
        .catch(err => console.error("Initial data load failed:", err));

      // Enable button once QR library is ready
      const checkLibrary = setInterval(() => {
        if (typeof Html5Qrcode !== "undefined") {
          clearInterval(checkLibrary);
          const btn = document.getElementById('start-btn');
          if (btn) { btn.innerText = "üì∑ START LIVE SCANNER"; btn.disabled = false; }
        }
      }, 500);

      // Poll for schedule changes every 15s
      setInterval(() => {
        callBackend({ action: "getLatestSchedule" })
          .then(checkForChanges)
          .catch(err => console.warn("Schedule poll failed:", err));
      }, 15000);

      function checkForChanges(newSchedule) {
        const sig = arr => arr.map(s => s.id + s.date + s.name + s.startTime + s.durationHours + s.offsetMinutes).join("|");
        if (sig(todaySessions) !== sig(newSchedule)) {
          todaySessions = newSchedule;
          const banner = document.getElementById('update-banner');
          banner.style.display = 'block';
          setTimeout(() => { banner.style.display = 'none'; }, 3000);
        }
      }

      // ‚îÄ‚îÄ Camera ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function switchCamera() {
        currentFacingMode = (currentFacingMode === "user") ? "environment" : "user";
        const btn = document.getElementById('start-btn');
        if (html5QrcodeScanner && btn.style.display === 'none') {
          html5QrcodeScanner.stop()
            .then(() => html5QrcodeScanner.clear())
            .then(() => { html5QrcodeScanner = null; isScannerRunning = false; startScanner(); })
            .catch(err => console.log("Switch failed", err));
        }
      }

      function startScanner() {
        const btn = document.getElementById('start-btn');
        btn.innerText = "‚è≥ Waking Camera...";
        btn.disabled = true;

        if (!html5QrcodeScanner) html5QrcodeScanner = new Html5Qrcode("reader");

        const qrboxFunction = (w, h) => {
        const s = Math.floor(Math.min(w, h) * 0.85);
        return { width: s, height: s };
        };
        const config = {
          fps: 15,
          qrbox: qrboxFunction,
          experimentalFeatures: {
            useBarCodeDetectorIfSupported: true
              },
          aspectRatio: 1.0,
          formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ]
          };

        html5QrcodeScanner.start({ facingMode: currentFacingMode }, config, onScanSuccess)
          .then(applyCameraUI)
          .catch(err1 => {
            console.warn("Attempt 1 Failed:", err1);
            try { html5QrcodeScanner.clear(); } catch(e) {}
            html5QrcodeScanner = new Html5Qrcode("reader");

            const fallback = (currentFacingMode === "environment") ? "user" : "environment";
            html5QrcodeScanner.start({ facingMode: fallback }, config, onScanSuccess)
              .then(() => { currentFacingMode = fallback; applyCameraUI(); })
              .catch(err2 => {
                console.warn("Attempt 2 Failed:", err2);
                try { html5QrcodeScanner.clear(); } catch(e) {}
                html5QrcodeScanner = new Html5Qrcode("reader");

                Html5Qrcode.getCameras().then(devices => {
                  if (devices && devices.length > 0) {
                    html5QrcodeScanner.start(devices[0].id, config, onScanSuccess)
                      .then(applyCameraUI)
                      .catch(triggerFinalError);
                  } else {
                    triggerFinalError("No cameras found.");
                  }
                }).catch(triggerFinalError);
              });
          });
      }

      function applyCameraUI() {
        document.getElementById('start-btn').style.display = 'none';
        document.querySelector('.cam-toggle').style.display = 'flex';
        isScannerRunning = true;
        const r = document.getElementById('reader');
        currentFacingMode === "user" ? r.classList.add('front-cam') : r.classList.remove('front-cam');
      }

      function triggerFinalError(err) {
        alert("Camera blocked: " + err + "\n\nAllow camera via the settings icon in your URL bar.");
        const btn = document.getElementById('start-btn');
        btn.innerText = "üì∑ START LIVE SCANNER";
        btn.disabled = false;
        btn.style.display = 'block';
      }

      // ‚îÄ‚îÄ Scan logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function onScanSuccess(decodedText) {
        if (isScanning) return;

        const cleanId = decodedText.toString().trim();
        const name = participantDB[cleanId];

        if (!name) { showStatus("Error", "‚õî Invalid ID", "error"); pauseAndReset(); return; }

        const sessionStatus = findCurrentSession();
        if (sessionStatus.status === "NONE")  { showStatus("Closed", "‚õî Session Closed.", "error"); pauseAndReset(); return; }
        if (sessionStatus.status === "EARLY") { showStatus("Too Early", "‚è≥ Opens at " + sessionStatus.timeStr, "error"); pauseAndReset(); return; }

        const activeSession = sessionStatus.session;
        const uniqueKey = cleanId + "_" + activeSession.id;

        if (localScannedIds.has(uniqueKey)) { showStatus(name, "‚ö†Ô∏è Already Scanned", "warning"); pauseAndReset(); return; }

        isScanning = true;
        if (html5QrcodeScanner && isScannerRunning) html5QrcodeScanner.pause();

        showStatus(name, "‚úÖ Checked In", "success-present");
        localScannedIds.add(uniqueKey);
        clearTimeout(statusTimer);
        statusTimer = setTimeout(closePopup, 2000);

        callBackend({ action: "processScan", scannedId: cleanId, participantName: name, sessionId: activeSession.id })
          .then(result => {
            if (result.status === "warning") {
              showStatus(name, result.message, "warning");
              clearTimeout(statusTimer);
              statusTimer = setTimeout(closePopup, 2000);
            }
          })
          .catch(err => console.error("processScan error:", err));
      }

      function findCurrentSession() {
        const now = new Date();
        let upcomingTime = null;
        for (let s of todaySessions) {
          const startObj = parseTimeString(s.startTime);
          if (!startObj) continue;
          const openObj = new Date(startObj.getTime() - ((Number(s.offsetMinutes) || 0) * 60000));
          const endObj  = new Date(startObj.getTime() + ((Number(s.durationHours)  || 4) * 3600000));
          if (now >= openObj && now < endObj) return { status: "OPEN", session: s };
          if (now < openObj && (!upcomingTime || openObj < upcomingTime)) upcomingTime = openObj;
        }
        if (upcomingTime) return { status: "EARLY", timeStr: upcomingTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) };
        return { status: "NONE" };
      }

      function parseTimeString(timeStr) {
        if (!timeStr) return null;
        const d = new Date();
        const lower = String(timeStr).toLowerCase();
        if (lower.includes('m')) {
          const p = lower.match(/(\d+):(\d+)\s*(am|pm)/);
          if (p) {
            let h = parseInt(p[1]), m = parseInt(p[2]);
            if (p[3] === 'pm' && h < 12) h += 12;
            if (p[3] === 'am' && h === 12) h = 0;
            d.setHours(h, m, 0, 0); return d;
          }
        }
        const p = String(timeStr).split(':');
        if (p.length >= 2) { d.setHours(parseInt(p[0]), parseInt(p[1]), 0, 0); return d; }
        return null;
      }

      function pauseAndReset() {
        isScanning = true;
        if (html5QrcodeScanner && isScannerRunning) html5QrcodeScanner.pause();
        clearTimeout(statusTimer);
        statusTimer = setTimeout(closePopup, 2000);
      }

      function closePopup() {
        document.getElementById('status-box').style.display = 'none';
        if (isScanning && html5QrcodeScanner && isScannerRunning) html5QrcodeScanner.resume();
        isScanning = false;
        clearTimeout(statusTimer);
      }

      function showStatus(title, desc, className) {
        const box = document.getElementById('status-box');
        box.className = "";
        box.classList.add(className);
        box.style.display = 'block';
        document.getElementById('msg-title').innerText = title;
        document.getElementById('msg-desc').innerText = desc;
      }
    </script>
  </body>
</html>
